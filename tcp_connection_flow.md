# TCPè¿æ¥è¿è¡Œé€»è¾‘è¯¦è§£

## ğŸ”„ å®Œæ•´è¿è¡Œæµç¨‹

### 1. Home Assistantå¯åŠ¨é˜¶æ®µ
```
Home Assistantå¯åŠ¨
    â†“
æ‰«æcustom_componentsç›®å½•
    â†“
å‘ç°MIIY_HRVç»„ä»¶
    â†“
åŠ è½½manifest.json
    â†“
æ³¨å†Œç»„ä»¶åˆ°Home Assistant
```

### 2. ç”¨æˆ·é…ç½®é˜¶æ®µ
```
ç”¨æˆ·åœ¨Home Assistantä¸­æ·»åŠ é›†æˆ
    â†“
è°ƒç”¨config_flow.pyè¿›è¡Œé…ç½®
    â†“
ç”¨æˆ·è¾“å…¥è®¾å¤‡IPå’Œç«¯å£
    â†“
åˆ›å»ºé…ç½®æ¡ç›®(ConfigEntry)
    â†“
ä¿å­˜åˆ°Home Assistanté…ç½®ä¸­
```

### 3. ç»„ä»¶åˆå§‹åŒ–é˜¶æ®µ (async_setup_entry)
```
é…ç½®æ¡ç›®è¢«åŠ è½½
    â†“
__init__.py:async_setup_entry()è¢«è°ƒç”¨
    â†“
åˆ›å»ºMiyaHRVDeviceå®ä¾‹ (æœªè¿æ¥)
    â†“
å­˜å‚¨è®¾å¤‡å®ä¾‹åˆ°hass.data[DOMAIN]
    â†“
è½¬å‘é…ç½®æ¡ç›®ç»™å„ä¸ªå¹³å°
```

### 4. å¹³å°è®¾ç½®é˜¶æ®µ
```
Climateå¹³å°:async_setup_entry()è¢«è°ƒç”¨
    â†“
ä»hass.data[DOMAIN]è·å–è®¾å¤‡å®ä¾‹
    â†“
è°ƒç”¨device.connect() â† ğŸ¯ TCPè¿æ¥å¼€å§‹
    â†“
åˆ›å»ºClimateå®ä½“
    â†“
å®ä½“æ·»åŠ åˆ°Home Assistant
```

### 5. TCPè¿æ¥è¯¦ç»†è¿‡ç¨‹
```
device.connect()è¢«è°ƒç”¨
    â†“
å¯¼å…¥tcp_485_libåº“
    â†“
åˆ›å»ºTCPå®¢æˆ·ç«¯å®ä¾‹
    â†“
è°ƒç”¨client.connect()å»ºç«‹TCPè¿æ¥
    â†“
è¿æ¥æˆåŠŸ â†’ å¯åŠ¨æ•°æ®ç›‘å¬ä»»åŠ¡
    â†“
è¿æ¥å¤±è´¥ â†’ è®°å½•é”™è¯¯æ—¥å¿—
```

### 6. æ•°æ®ç›‘å¬é˜¶æ®µ
```
è¿æ¥æˆåŠŸå
    â†“
å¯åŠ¨_listen_for_data()å¼‚æ­¥ä»»åŠ¡
    â†“
æŒç»­ç›‘å¬è®¾å¤‡æ•°æ®
    â†“
è§£ææ¥æ”¶åˆ°çš„æ•°æ®
    â†“
é€šçŸ¥æ‰€æœ‰ç›‘å¬å™¨(å®ä½“)
```

### 7. å®ä½“æ“ä½œé˜¶æ®µ
```
ç”¨æˆ·åœ¨Home Assistantä¸­æ“ä½œå®ä½“
    â†“
è°ƒç”¨å®ä½“çš„async_set_*æ–¹æ³•
    â†“
å®ä½“è°ƒç”¨device.send_command()
    â†“
é€šè¿‡TCPå‘é€å‘½ä»¤åˆ°è®¾å¤‡
    â†“
è®¾å¤‡å“åº”æ•°æ®
    â†“
_listen_for_data()æ¥æ”¶å¹¶è§£æ
    â†“
é€šçŸ¥å®ä½“æ›´æ–°çŠ¶æ€
```

### 8. ç»„ä»¶å¸è½½é˜¶æ®µ
```
ç”¨æˆ·åˆ é™¤é›†æˆæˆ–Home Assistanté‡å¯
    â†“
è°ƒç”¨async_unload_entry()
    â†“
å¸è½½æ‰€æœ‰å¹³å°
    â†“
è°ƒç”¨device.disconnect()
    â†“
æ–­å¼€TCPè¿æ¥
    â†“
æ¸…ç†èµ„æº
```

## â° å…³é”®æ—¶æœºç‚¹

### ğŸ¯ TCPè¿æ¥æ—¶æœº
- **æ—¶æœº**: Climateå¹³å°è®¾ç½®æ—¶
- **ä½ç½®**: `climate.py:async_setup_entry()` ç¬¬58è¡Œ
- **ä»£ç **: `await device.connect()`
- **æ¡ä»¶**: é…ç½®æ¡ç›®å­˜åœ¨ä¸”æœ‰æ•ˆ

### ğŸ”Œ è¿æ¥å»ºç«‹è¿‡ç¨‹
```python
# åœ¨device.pyä¸­
async def connect(self):
    # 1. å¯¼å…¥TCPåº“
    from tcp_485_lib import create_client
    
    # 2. åˆ›å»ºå®¢æˆ·ç«¯
    self.client = create_client(self.host, self.port, "hex")
    
    # 3. å»ºç«‹è¿æ¥
    if await self.client.connect():
        # 4. å¯åŠ¨ç›‘å¬ä»»åŠ¡
        asyncio.create_task(self._listen_for_data())
        return True
```

### ğŸ“¡ æ•°æ®ç›‘å¬å¯åŠ¨
- **æ—¶æœº**: TCPè¿æ¥æˆåŠŸåç«‹å³å¯åŠ¨
- **æ–¹å¼**: å¼‚æ­¥ä»»åŠ¡(asyncio.create_task)
- **åŠŸèƒ½**: æŒç»­ç›‘å¬è®¾å¤‡æ•°æ®
- **ç”Ÿå‘½å‘¨æœŸ**: ç›´åˆ°è®¾å¤‡æ–­å¼€è¿æ¥

## ğŸš¨ é”™è¯¯å¤„ç†

### è¿æ¥å¤±è´¥
- è®°å½•é”™è¯¯æ—¥å¿—
- è¿”å›False
- å®ä½“ä»ä¼šåˆ›å»ºï¼Œä½†æ— æ³•ä¸è®¾å¤‡é€šä¿¡

### è¿æ¥æ–­å¼€
- è‡ªåŠ¨é‡è¿æœºåˆ¶(å¦‚æœåº“æ”¯æŒ)
- è®°å½•æ–­å¼€æ—¥å¿—
- æ¸…ç†ç›‘å¬ä»»åŠ¡

## ğŸ“‹ æ€»ç»“

**TCPè¿æ¥æ—¶æœº**: åœ¨Climateå¹³å°è®¾ç½®æ—¶ï¼Œå³ç”¨æˆ·é…ç½®å®Œé›†æˆåï¼ŒHome AssistantåŠ è½½ç»„ä»¶æ—¶è‡ªåŠ¨å»ºç«‹TCPè¿æ¥ã€‚

**è¿æ¥ç”Ÿå‘½å‘¨æœŸ**: 
- å»ºç«‹: ç»„ä»¶åˆå§‹åŒ–æ—¶
- ç»´æŒ: æ•´ä¸ªç»„ä»¶è¿è¡ŒæœŸé—´
- æ–­å¼€: ç»„ä»¶å¸è½½æ—¶

**æ•°æ®æµ**: åŒå‘é€šä¿¡
- å‘é€: ç”¨æˆ·æ“ä½œ â†’ å®ä½“ â†’ è®¾å¤‡ â†’ TCPå‘é€
- æ¥æ”¶: è®¾å¤‡ â†’ TCPæ¥æ”¶ â†’ è§£æ â†’ å®ä½“æ›´æ–° 